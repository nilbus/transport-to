#!/usr/bin/env bash

set -e

echo "üöÄ Setting up Transport To extension for Arc browser..."
echo

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Check if Arc browser is installed
if [ ! -d "/Applications/Arc.app" ]; then
  echo "‚ùå Error: Arc browser not found at /Applications/Arc.app/"
  echo "   Please install Arc browser first."
  exit 1
fi
echo "‚úì Arc browser found"

# Check if jq is installed (needed by the native host script)
if ! command -v jq &> /dev/null; then
  echo "‚ùå Error: jq is not installed"
  echo "   Install it with: brew install jq"
  exit 1
fi
echo "‚úì jq is installed"

# Make the native host script executable
NATIVE_HOST_SCRIPT="$PROJECT_DIR/native-host/transport-to-host.sh"
chmod +x "$NATIVE_HOST_SCRIPT"
echo "‚úì Made native host script executable"

# Create NativeMessagingHosts directories if they don't exist
# Note: Arc browser appears to check Chrome's directory instead of its own
ARC_NATIVE_HOSTS_DIR="$HOME/Library/Application Support/Arc/NativeMessagingHosts"
CHROME_NATIVE_HOSTS_DIR="$HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
mkdir -p "$ARC_NATIVE_HOSTS_DIR"
mkdir -p "$CHROME_NATIVE_HOSTS_DIR"
echo "‚úì Created native messaging hosts directories"

# Copy the native host manifest to both directories
MANIFEST_SOURCE="$PROJECT_DIR/native-host/com.nilbus.transportto.native.json"
cp "$MANIFEST_SOURCE" "$ARC_NATIVE_HOSTS_DIR/com.nilbus.transportto.native.json"
cp "$MANIFEST_SOURCE" "$CHROME_NATIVE_HOSTS_DIR/com.nilbus.transportto.native.json"
echo "‚úì Installed native host manifest to Arc and Chrome directories"

echo
echo "üìã Next steps:"
echo "1. Open Arc browser and navigate to: arc://extensions"
echo "2. Enable 'Developer mode' (toggle in the top right)"
echo "3. Click 'Load unpacked'"
echo "4. Select: $PROJECT_DIR/extension"
echo
echo "‚úÖ Setup complete!"
